# SpeciesNet

Uses [SpeciesNet](https://github.com/google/cameratrapai).

Uses CUDA 12.1 and SpeciesNet 4.0.1.


## Quick start

### Inhouse registry

* Log into registry using *public* credentials:

  ```bash
  docker login -u public -p public public.aml-repo.cms.waikato.ac.nz:443 
  ```

* Pull and run image (adjust volume mappings `-v`):

  ```bash
  docker run --gpus=all --shm-size 8G --net=host \
    -v /local/dir:/container/dir \
    -it public.aml-repo.cms.waikato.ac.nz:443/tensorflow/speciesnet:4.0.1_cuda12.1
  ```

### Docker hub

* Pull and run image (adjust volume mappings `-v`):

  ```bash
  docker run --gpus=all --shm-size 8G --net=host \
    -v /local/dir:/container/dir \
    -it waikatodatamining/speciesnet:4.0.1_cuda12.1
  ```

### Build local image

* Build the image from Docker file (from within /path_to/speciesnet/4.0.1_cuda12.1)

  ```bash
  docker build -t speciesnet .
  ```
  
* Run the container

  ```bash
  docker run --gpus=all --shm-size 8G --net=host -v /local/dir:/container/dir -it speciesnet
  ```
  `/local/dir:/container/dir` maps a local disk directory into a directory inside the container


## Publish images

### Build

```bash
docker build -t speciesnet:4.0.1_cuda12.1 .
```

### Inhouse registry  

* Tag

  ```bash
  docker tag \
    speciesnet:4.0.1_cuda12.1 \
    public-push.aml-repo.cms.waikato.ac.nz:443/tensorflow/speciesnet:4.0.1_cuda12.1
  ```
  
* Push

  ```bash
  docker push public-push.aml-repo.cms.waikato.ac.nz:443/tensorflow/speciesnet:4.0.1_cuda12.1
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```bash
  docker login public-push.aml-repo.cms.waikato.ac.nz:443
  ```

### Docker hub  

* Tag

  ```bash
  docker tag \
    speciesnet:4.0.1_cuda12.1 \
    waikatodatamining/speciesnet:4.0.1_cuda12.1
  ```
  
* Push

  ```bash
  docker push waikatodatamining/speciesnet:4.0.1_cuda12.1
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```bash
  docker login
  ``` 


### Requirements

```bash
docker run --rm --pull=always \
  -it public.aml-repo.cms.waikato.ac.nz:443/tensorflow/speciesnet:4.0.1_cuda12.1 \
  pip freeze > requirements.txt
```

**NB:** CUDA preamble may need removing.


## Scripts

* `speciesnet_build_geofence_release` - runs `python -m speciesnet.scripts.build_geofence_release`
* `speciesnet_gpu_test` - runs `python -m speciesnet.scripts.gpu_test`
* `speciesnet_run_model` - runs `python -m speciesnet.scripts.run_model`
* `speciesnet_run_server` - runs `python -m speciesnet.scripts.run_server`
* `speciesnet_to_md` - runs `python -m speciesnet.scripts.speciesnet_to_md`
* `speciesnet_predict_poll` - for generating predictions via file-polling (calls `/opt/speciesnet/predict_poll.py`)
* `speciesnet_predict_redis` - for generating predictions via Redis (calls `/opt/speciesnet/predict_poll.py`)


## Permissions

When running the docker container as regular use, you will want to set the correct
user and group on the files generated by the container (aka the user:group launching
the container):

```bash
docker run -u $(id -u):$(id -g) -e USER=$USER ...
```

## Caching

SpeciesNet will download pretrained models and cache them locally. To avoid having
to download them constantly, you can the cache directory to the host machine.
Some other libraries, like Matplotlib, will want to cache things as well, so you
would want to cache these as well.

* when running the container as current user add the following parameters

  ```bash
  -v /some/where/cache:/.cache \
  -v /some/where/cache:/.torch \
  -v /some/where/config:/.config \
  ```

